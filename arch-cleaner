#!/bin/bash

# Clean Arch Linux system
set -euo pipefail

# Check if script is run as root
if [ "$(id -u)" -ne 0 ]; then
    echo "Please run as root or with sudo." >&2
    exit 1
fi

echo "Starting system cleanup..."

# Update package databases and upgrade all packages 
echo -e "\nUpdating system ..."
pacman -Syyu --noconfirm

# Remove orphaned packages
echo -e "\nRemoving orphaned packages..."
orphaned=$(pacman -Qtdq 2>/dev/null || true)
if [[ -n "$orphaned" ]]; then
    echo "$orphaned" | pacman -Rns --noconfirm -
else
    echo "No orphaned packages found."
fi

# Clear pacman cache
echo -e "\nClearing pacman package cache..."
pacman -Scc --noconfirm

# Remove unused packages
echo -e "\nRemoving unused packages..."
unused=$(pacman -Qdqtt 2>/dev/null || true)
if [[ -n "$unused" ]]; then
    echo "$unused" | pacman -Rns --noconfirm -
else
    echo "No unused packages found."
fi

# Clean journal logs (keep last 50MB)
echo -e "\nCleaning systemd journal logs..."
journalctl --vacuum-size=50M

# Remove temporary files
echo -e "\nRemoving temporary files..."
rm -rf /tmp/* /var/tmp/*

# Clean cache in home directories
echo -e "\nCleaning user cache..."
for userdir in /home/*; do
    user=$(basename "$userdir")
    if [ -d "$userdir/.cache" ]; then
        echo "Cleaning cache for user $user"
        rm -rf "$userdir/.cache/"*
    fi
done

echo -e "\nCleanup complete!"
